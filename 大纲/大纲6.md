### 01.删除接口

```js
// cart.js
router.post('/cart/remove', cartController.remove)
exports.remove = (req, res, next) => {
    const id = req.body.id
    if (!req.session.user) {
        //获取
        const cartCookie = req.cookies[configs.cartCookie.key] || '[]'
        const cartList = JSON.parse(cartCookie)
        //删除
        const index = cartList.findIndex((item, i) => item.id == id)
        cartList.splice(index, 1)
        //存储
        const expires = new Date(Date.now() + configs.cartCookie.expires)
        res.cookie(configs.cartCookie.key, JSON.stringify(cartList), {expires})
        res.json({code: 200,msg: '删除成功' })
    } else {
        //TODO
```

### 02.前端删除完成

```js
// cart.art    删除页面一定要种id
$('.cart-list').on('click', '.btn_remove', function () {
            const id = this.dataset.id
            $.post('/cart/remove', {
                id
            }, (data) => {
                if (data.code == 200) {
                    $(this).parents('.goods-list').remove()
                    calc()
                } else {
                    alert(data.msg)
                }
            })
        })
```

### 03.路由规则设置

```js
router.get('/login', userController.login) // get 页面展示
router.post('/login', userController.loginLogic) //  post 业务处理
```

### 04.登录成功后的回调逻辑

几种情况会到登录页:

1. 浏览器直接访问/login
2. 购物车 点击登录按钮
3. 结算 走结算路由 登录状态的判断 重定向到登录页

来源两种情况:

1. 如果没有来源  个人中心首页

2. 如果有来源地址 从哪里来回哪里去

   - 点击登录把当前地址拼到url地址

   - 登录成功把地址取出重定向

     */login?returnUrl=当前地址*

### 05.登录页面准备

立即登录 a标签 /login?returnUrl=/cart

cart.art

```js
{{extend './layout/basic.art'}}
{{block 'styles'}}
<link rel="stylesheet" href="/assets/css/page-account.css">
{{/block}}
{{block 'scripts'}}
<script src="/assets/js/sui.tab.js"></script>
{{/block}}
{{block 'body'}}
	内容 资源路径要改
{{/block}}
```

去成品网站 把第三个验证码的input copy过来

### 06.svg-captcha验证码

```js
// 通过svb-captcha包、生成svg格式图片、svg标签是html
const svgCaptcha = require('svg-captcha')
exports.login = (req, res, next) => {
  //1. 通过 svg-captcha 的包  生产svg格式的图片   svg标签 HTML
const captcha = svgCaptcha.createMathExpr({
    width: 120,
    height: 30,
    fontSize: 30
})
  //2. captcha {data:svg格式图片,text:图片的内容或者公式结果}
res.locals.svg = captcha.data  // @svg页面输出
req.session.text = captcha.text //记录结果  下次校验对比
  //需要回跳地址
res.locals.returnUrl = req.query.returnUrl || '/member' //个人中心首页
res.render('login.art')
}
```

### 07.登录逻辑实现步骤

```js
exports.loginLogic
// 需求:
// 1. 保证表单数据完整性(校验)
// 2. 验证码(校验)
// 3. 用户名和密码调接口(校验)
// 4. 如果自动登录选中 准备自动登录的数据
// 5. 合并购物车
// 6. 补充:错误提示统一处理
```

### 08.错误捕获

```js
修改login.art
form   action="/login" method="post"
name="username" name="password" name="captcha" name="auto" value="1" 
登录button  立即注册 /register
//loginLogic方法
const {username,password, captcha,auto} = req.body
Promise.resolve().then(() => {
 if (!(username && password && captcha)) throw createError(456, '表单必须输入完整')
    }).catch(err => {res.send(err.message) })
```

### 09.错误处理

```js
.catch(err => { // 错误处理:自己创建的信息和程序运行时错误信息 
        if (err.status === 456) { 
           res.locals.msg = err.message
        } else {res.locals.msg = '登录失败'}
//判断msg渲染模板 
{{if msg}}
   <div class="sui-msg msg-error" style="margin-left: 20px">
   <div class="msg-con">{{msg}}</div>
   <s class="msg-icon"></s>
   </div>
{{/if}}
//重新生成验证
const captcha = svgCaptcha.createMathExpr({width: 120,height: 30,fontSize: 30})
      res.locals.svg = captcha.data   
res.render('login.art')     
```

### 10.验证码校验

```js
1. 登录页面展示时
  - 生成的校验码存到session
  - 存校验码  下次登录请求做对比
2.登录逻辑页面 验证码的校验(传过来的验证码跟session里的做比较)
//login和loginLogic方法 都在render之前加上这句话
 req.session.text = captcha.text
//验证表单 下面加上
 if (captcha != req.session.text) throw createError(456, '验证码错误')
```

### 11.验证用户名和密码

```js
// models/user.js
const axios = require('./axiosInstance')
exports.login = (username, password) => {
    return axios.post('/users/login', {username,password  }).then(res => res.data)
    .catch(err => Promise.reject(err))             
}
//两个错误下面
return usersModel.login(username, password) 
//用then接一下 then里面user
if (!user) throw createError(456, '登录失败')
req.session.user = user // 登录成功
// 程序错误信息更详细
.catch(err => {	
if (err.status === 456) {
    res.locals.msg = err.message
} else {
	if (err.response) {res.locals.msg = err.response.data.message || '登录失败'
 	} else {res.locals.msg = '登录失败'}                        
```

### 12.分析自动登录需要保存的信息

- 点自动登录 登录成功以后存返回的信息里面的id和password
- 服务端会根据传过来的cookie信息判断
- 判断之前有没有存储自动登录信息
- 如果有拿出来 id和password
  1. 根据id获取用户信息
  2. 根据用户信息里面password判断是否和你cookie存储的password一致
  3. 登陆成功 把返回的用户信息 存到user

### 13.保存自动登录所需要的数据

1.在config里面配置需要保存的cookie信息

2.根据登陆成功返回的user信息  把id和password转成字符串存到cookie

```js
//configs.js 里面设置有效期7天
exports.loginCookie = {
    key: 'pyg_cart_inf',
    expires: 7 * 24 * 60 * 60 * 1000
}
//user.js 登录成成以后then里面
.then(user => {
    if (!user) throw createError(456, '登入失败')
    req.session.user = user
	if (auto) { // 自动登录
    	res.cookie(configs.loginCookie.key, JSON.stringify({
        id: user.id, pwd: user.password}), 
    { expires: new Date(Date.now() + configs.loginCookie.expires),
       httpOnly: true //只能web服务器操作 更安全一些})}
```

### 14.合并购物车

1. 获取客户端存储的购物车信息
2. 会有若干条商品 分别添加到账号下
3. 合并成功 清除客户端的购物车信息

```js
// 接着上面写
const cartCookie = req.cookies[configs.cartCookie.key] || '[]'
const cartList = JSON.parse(cartCookie)
const promiseArr = cartList.map((item, i) => cartModel.add(user.id, item.id, item.num))
return Promise.all(promiseArr)
// then接一下 清空购物车
res.clearCookie(configs.cartCookie.key)
res.redirect(req.body.returnUrl || '/member') //严谨操作
// models/cart.js
exports.add = (userId, id, num) => {
  return axios.post(`users/${userId}/cart`, {id, amount: num})
    .then(res => res.data)
    .catch(err => Promise.reject(err))
}
```

### 15.回调地址处理

```js
// login方法里面 render之前
req.locals.returnUrl = req.query.returnUrl || 'member' //默认个人中心
//login.art form下面 存上
<input type="hidden" name="returnUrl" value="{{returnUrl}}">
//然后登录成功清楚cookie以后
res.redirect(req.body.returnUrl || '/member') //严谨操作  
//登录失败重新生成验证码 render之前
res.locals.returnUrl = req.body.returnUrl || 'member'
```

### 16.登录状态获取列表信息

```js
//调接口传用户id 返回登录状态下的列表信息
//models/cart.js
exports.list = (userId) => {
    return axios.get(`users/${userId}/cart`)
        .then(res => res.data)
        .catch(err => Promise.reject(err))
}
//controller/cart.js 里面TODO调用 引model别忘了  写到controller/cart里面list的else里面
cartModel.list(req.session.user.id).then(data => { 
            res.json({
                code: 200,
                list: data.map((item, i) => ({
                    id: item.id,
                    name: item.name,
                    thumbnail: item.thumbnail,
                    price: item.price,
                    amount: 100,
                    num: item.amount
                  }))
            })
}).catch(err => { 
    res.json({code:500,msg:'恭喜购物车信息失败'})
})

```

### 17.登录状态添加购物车

```js
//controller/cart里面addCart方法else
//登录状态的添加购物车
cartModel.add(req.session.user.id, id, num)
   .then(data => {        //添加成功
   res.redirect(`/cart/addCartSuccess?id=${id}&num=${num}`)
}).catch(err => next(err))
// model/cart.js
exports.add = (userId, id, num) => {
  return axios.post(`users/${userId}/cart`, {id, amount: num})
    .then(res => res.data)
    .catch(err => Promise.reject(err))
}
```

### 18.登录状态修改&删除操作 (这两个操作要用patch请求)

```js
exports.edit = (userId, id, num) => {
  return axios.patch(`users/${userId}/cart/${id}`,{amount:num})
    .then(res => res.data)
    .catch(err => Promise.reject(err))
}
exports.remove = (userId, id) => {
  return axios.delete(`users/${userId}/cart/${id}`)
    .then(res => res.data)
    .catch(err => Promise.reject(err))
}
```

```js
// 修改和删除 else 里面 操作登录状态
cartModels.edit(req.session.user.id, id, num)
      .then(data => {
        res.json({code: 200, msg: '修改成功'})
      }).catch(err => {
      res.json({code: 500, msg: '修改失败'})
})
  cartModels.remove(req.session.user.id, id)
    .then(data => {
      res.json({code: 200, msg: '删除成功'})
    }).catch(err => {
    res.json({code: 500, msg: '删除失败'})
```

### 19.路由规则约定

```js
结算路由 /checkout
```

### 20.登录拦截功能

```js
因为很多地方用到 所以拦截路由中间件
// middlewares.js
exports.checkLogin = (req, res, next) => { 
    if (!req.session.user) { 
    return res.redirect('/login?returnUrl=' + encodeURIComponent(req.url))}           
    next()
}
// router.js 引入middlewares.js
router.get('/checkout',middwares.checkLogin,orderController.checkout)
```

