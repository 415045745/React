### 01.思路分析&cookie添加商品信息

根据session状态区分 已登录和未登录   登录成功  用户信息存在user字段

​        // 未登录

​        // 1.存储cookie 存储格式 键值对字符串 键 pyg_cart_info 值是字符串数组

​        // 2.加入商品信息 就是往这个字符串数组追加 所以得先获取cookie信息

​        // cookie拿出来最好是对象 根据key获取 中间件处理数据cookie-parse

​        // 3.设置pyg_cart_info 有效期 购物车的配置信息放到configs

​        // 4.获取出来的数据是json字符串数组 转换成数组才好操作

​        // 5.添加数据 正常直接追加 特殊遇见相同的商品 数量累加

​        // 6.修改完数组 存到cookie 更新cookie 

​        // 7.重定向 添加成功提示页面

```js
// configs.js
exports.cartCookie = {
    key: 'pyg_cart_inf',
    expires: 30 * 24 * 60 * 60 * 1000
}
```

```js
// 2.app.js
const cookieParser = require('cookie-parser')
app.use(cookieParser())
// 1.cart.js
const configs = require('../configs')
const productModel = require('../models/product')
exports.addCart = (req, res, next) => {
const id = req.query.id   //商品ID
const num = req.query.num  //添加的数量
if (!req.session.user) {
const cartCookie = req.cookies[configs.cartCookie.key] || '[]'
const cartList = JSON.parse(cartCookie)
const item = cartList.find((item, i) => item.id == id)
if (item) {
    item.num = parseInt(item.num) + parseInt(num)
} else {cartList.push({ id,num})}
const expires = new Date(Date.now() + configs.cartCookie.expires)
res.cookie(configs.cartCookie.key, JSON.stringify(cartList), {expires})
res.redirect(`/cart/addCartSuccess?id=${id}&num=${num}`)	
} else {。。。。
```

//测试:decodeURIComponent(cookie的value值)

### 02.成功提示页面

getProductByBaseId这个方法product复制根据id获取 然后参数都不要

```js
// models/product.js获取商品基本信息根据ID
exports.getProductBaseById = (id) => {
  return axios.get(`products/${id}`)
    .then(res => res.data)
    .catch(err => Promise.reject(err))
}
```

```js
// controllers/cart.js	
exports.addCartSuccess = (req, res, next) => {
  const {id,num} = req.query
  //获取商品基本信息
  productModel.getProductBaseById(id)
    .then(data => {
      res.locals.product = {
        id: data.id, name: data.name, thumbnail: data.thumbnail, num }
      res.render('cart-add.art')
    }).catch(err => next(err))
}
// cart-add.art
<div class="left-pic"><img src="{{product.thumbnail}}"></div> 
<div class="right-info">
<p class="title">{{product.name}}</p>             
<p class="attr">数量：{{product.num}}</p></div>             
<a href="/item/{{product.id}}" class="sui-btn btn-xlarge">查看商品详情</a>
<a href="/cart" class="sui-btn btn-xlarge btn-danger ">去购物车结算 ></a>               
```

### 03.准备静态页面

```js
// 1.index负责返回静态页面和list负责返回给前台购物车数据格式json
router.get('/cart', cartController.index)
router.get('/cart/list', cartController.list)
// 2.controllers/cart.js
exports.index = (req, res, next) => {
    res.locals.user = req.session.user
    res.render('cart.art')
}
// 3.cart.art
{{if !user}}
    <div class="sui-msg msg-large msg-block msg-warning">
        <div class="msg-con">您还没有登录！登录后购物车的商品将保存到您账号中 <a href="/login" class="sui-btn btn-danger">立即登录</a></div>
        <s class="msg-icon"></s>
    </div>
{{/if}}
<div class="allgoods">
```

### 04.准备列表数据

```js
// controllers/cart.js
exports.list = (req, res, next) => {
   if (!req.session.user) {
        const cartCookie = req.cookies[configs.cartCookie.key] || '[]'
        const cartList = JSON.parse(cartCookie)
        // 假如有多个商品 需要等数据都拿到在去渲染 所以用promise.all
        const promiseArr = cartList.map((item, i) => 	productModel.getProductByBaseId(item.id))
        Promise.all(promiseArr).then(results => {
            res.json({
                code: 200,
                list: results.map((item, i) => ({ //用()包住才能返回
                    id: item.id,
                    name: item.name,
                    thumbnail: item.thumbnail,
                    price: item.price,
                    amount: item.amount, //库存信息
                    num: +cartList[i].num //cartList promiseArr results 顺序都是一样的
                }))
            })
        }).catch(err => {
            res.json({
                code: 500,
                msg: '获取购物车信息失败'
            })
        })
    } else {//TODO }}                      
```

### 05.准备前台模板

```js

```

### 06.模板渲染

```js
    // 第一步
<script>
    $(function () {
      	//如果前后端都用模板引擎 需要修改解析语法
        //规则<%js语法%>改成<?js语法?> 把前后两个%换成\?
        template.defaults.rules[0].test = /<\?(#?)((?:==|=#|[=-])?)[ \t]*([\w\W]*?)[ \t]*(-?)\?>/;
        $.get('/cart/list', function (data) {
            var html = template('list', data)
              //做数据缓存 目的以后方便操作
      		  window.list = data.list
             $('.cart-list').html(html)
        })
    })
</script>  
// cart.art
// 第三步
<script type="text/template" id="list">
    <? for(var i=0;i<list.length;i++){ ?>
    <? var item = list[i] ?>
         <li class="yui3-u-1-24"><input type="checkbox" data-id="<?=item.id?>"></li>
     	<a href="/item/<?=item.id?>"><img src="<?=item.thumbnail?>"></a>
    	<a href="/item/<?=item.id?>"><?=item.name?></a>
     	<span class="price">￥<?=item.price?></span>
     <a href="javascript:;" class="increment mins">-</a>
<input type="text" readonly class="itxt" data-id="<?=item.id?>" value="<?=item.num?>"
                   data-max="<?=item.amount?>" autocomplete="off">
     <a href="javascript:;" class="increment plus">+</a>
    <span class="sum">￥<?=(item.num*item.price).toFixed(2)?></span>
<? } ?>
</script>
// 第二步 
<script src="/assets/js/template-web.js"></script>
// 第一步

```

### 07.功能分析

1. 单选   
2. 全选   
3. 修改数量    前后交互  需要接口 
4. 删除            前后交互 需要接口 

以上4个修改 总价总数量 都改变

### 08.单选

```js
1.单选
$('.cart-list').on('change', '[type="checkbox"]', function () {
    const checkedLen = $('.cart-list [type="checkbox"]:checked').length
    const lisLen = $('.cart-list > ul').length
    $('.cart-th [type="checkbox"]').prop('checked', checkedLen === lisLen)
})
2.总数的计算和金额计算 看下面的函数
```

### 09.计算金额和总数

```js
calc() 这个函数放在定义模板语法下面
var calc = function () {
    // 1.获取全部选中的input不包含头部
    // 2.根据当前选中的商品去找数量和单价 
    //  window.list = data.list
    // 3.在input里面种上id 然后去list去找对应的数量和价格
    var $checkedInputList = $('.cart-list [type="checkbox"]:checked')
    var count = 0
    var total = 0
    $checkedInputList.each(function (i, item) {
        var id = item.dataset.id
        var product = list.find((item, i) => item.id == id)
        count += product.num
        total += product.num * product.price
    })
    $('strong').html(count)
    $('.summoney').html('¥' + total.toFixed(2))
}
```

### 10.全选功能

```js
$('.cart-th').on('change', '[type="checkbox"]', function () {
$('.cart-list [type="checkbox"]').prop('checked', $(this).prop('checked'))
calc()
})
```

### 11.定义修改数量的路由规则

```js
// 1.router.js
router.post('/cart/edit', cartController.edit)
// 2.自定义中间件上面定义 处理post中间件
app.use(express.json())
app.use(express.urlencoded({
    extended: false //加上以后键值对转换成对象
}))
```

### 12.定义修改数量接口

```js
// 2.cart.js 修改购物车商品数量的接口 返回json
exports.edit = (req, res, next) => {
    if (!req.session.user) {
    //约定传参 id num 请求方式 post
    const {id,num} = req.body
    //获取购物车数据
    const cartCookie = req.cookies[configs.cartCookie.key] || '[]'
    const cartList = JSON.parse(cartCookie)
    //修改
    const product = cartList.find((item, i) => item.id == id)
    product.num = +num
    //存储
    const expires = new Date(Date.now() + configs.cartCookie.expires)
    res.cookie(configs.cartCookie.key, JSON.stringify(cartList), {expires})
    //成功
    res.json({code: 200,msg: '修改成功'})
  } else {//TODO } }
控制台验证:$.post('/cart/edit',{id:12,num:100},function(data){console.log(data)})
```

### 13.前端加和减的交互效果

```js
// 2.点击
 $('.cart-list').on('click', '.increment', function () {
      var $input = $(this).siblings('input')
      //获取当前value值
      var num = $input.val()
      var max = $input.data('max')
      var id = $input.data('id')
      if ($(this).hasClass('mins')) {
        //减
        if (num < 2) return false    
          num--
      } else {
        //加
        if (num >= max) return false
        num++
      }
      //测试
      $input.val(num)
      	接14修改商品数量 
    })

```

### 14.修改商品数量 

```js
//$input.val(num)
$.post('/cart/edit', {id, num}, (data) => {
        if (data.code == 200) {
          //操作成功
          //1. 修改数量
          $input.val(num)
          //2. 修改小计
          var product = list.find((item, i) => item.id == id)
          product.num = num
          $(this).parent().next().find('span').html('￥' + (product.num * product.price).toFixed(2))
          //3. 修改总数量和总金额
          calc()
        } else {
          alert(data.msg)
        }
      })
```
