**reduce方法用法   删除有问题 查看全部订单加路由拦截** 

```js
var sum = arr.reduce(function(prev, cur, index, arr) {
console.log(prev, cur, index);
return prev + cur;
}，0) //注意这里设置了初始值
console.log(arr, sum);
```

# 成功回调模板和全部订单模板需要准备

### 01.头部登录退出

- 判断登录退出需要user信息（多处重用） 

- 把cart.js里面index方法里面的user信息放到中间件

  ```js
  res.locals.user=req.session.user //把这句话放到middlewarre里面的global方法里面
  ```

  ```js
  //header.art 
  {{if !user}}
  <a href="/login">登录</a>
  <a href="/register">免费注册</a>
  {{else}}
   <a href="/member">{{user.username}}</a>
  <a href="/logout">退出登录</a>
  {{/if}}
  ```

  ```js
  // router.js
  router.get('/logout', usersController.logout)
  ```

  ```js
  // user.js
  exports.logout = (req,res,next) => { 
      delete req.session.user
      res.redirect('/login')
  }
  ```

### 02.定义头部购物车信息

```js
//middleWare.js
exports.headCart = (req, res, next) => { 
    // 获取网页头部购物车需要的数据

    next()
}
// app.js
app.use(middlewares.global,middlewares.headCart)
```

### 03.头部购物车信息完成

```js
// 1. middleware.js 准备数据
const productModel = require('./models/product')
exports.headCart = (req, res, next) => {
    // 获取网页头部购物车需要的数据
    if (!req.session.user) {
        //cookie购物车
        const cartCookie = req.cookies[configs.cartCookie.key] || '[]'
        const cartList = JSON.parse(cartCookie)
        const cartNum = cartList.reduce((prev, item) => prev + parseInt(item.num), 0)
        const promiseArr = cartList.map((item, i) => productModel.getProductByBaseId(item.id))
        Promise.all(promiseArr).then(results => {
            res.locals.headCart = {
                cartNum,
                cartList: results.map((item, i) => item.name)
            }
            next()
        }).catch(err => next(err))
    } else {
        //服务器购物车
        cartModel.list(req.session.user.id).then(data => {
            res.locals.headCart = {
            cartNum: data.reduce((prev, item) => prev + parseInt(item.amount), 0),
            cartList: data.map((item, i) => item.name)
            }
            next()
        }).catch(err => next(err))
    }
}

// 2.渲染模板 header.art
<i class="shopnum">{{headCart.cartNum}}</i>
<div class="clearfix shopcarlist">
    <ul>
    {{each headCart.cartList}}
    <li>{{$value}}</li>
    {{/each}}
     </ul>
</div>  
// 3. cart.art 修改和删除 都用底下这两句话 calc下面
   //修改方法补充 修改头部的购物车数量
$('.shopnum').html(list.reduce((prev, item) => prev + parseInt(item.num), 0))
$('.shopcarlist ul').html(list.reduce((prev, item) => prev + `<li>${item.name}</li>`, ''))
  // 删除的方法 calc下面加上面这两句 还得在calc方法上面加上这一句s
  list.splice(list.findIndex((item, i) => item.id == id), 1)
```

### 04.定义路由规则

```js
// router.js
router.get('/checkout', middlewares.checkLogin, orderController.checkout) //结算页面
router.get('/order/add', middlewares.checkLogin, orderController.addOrder) //生成订单
// order.js
exports.addOrder = (req, res, next) => {
    // 生成订单
    res.redirect('/checkout')
}
exports.checkout = (req, res, next) => {
    // 核对订单 结算页面
    res.send('ok')
}
```

### 05.多件商品数据传参

```js
// cart.art 结算前端结算按钮点击 多个参数传过来 结算按钮/checkout 改成 javascript:;
$('.sum-btn').on('click', function () {
    //跳转地址  /order/add?items=12,13
    const items = []
    $('.cart-list [type="checkbox"]:checked').each(function () {
        items.push(this.dataset.id)
    })
    if (!items.length) return //没有选中 阻止跳转
    location.href = '/order/add?items=' + items.join(',')
})
测试:console.log(req.query.items)
```

### 06.生成订单完成

```js
// 1.models/order.js
const axios = require('./axi	osInstance')
//添加订单
exports.add = (userId, items) => {
    return axios.post(`orders`, { user_id: userId, items })
    .then(res => res.data).catch(err => Promise.reject(err))}  

// 2.controller/order.js拿到参数发请求获取信息
const orderModel = require('../models/order')
exports.addOrder = (req, res, next) => {
    //需要传参  用户ID  商品的ID多个以逗号分隔
    const items = req.query.items
    orderModel.add(req.session.user.id, items)
        .then(order => {
        res.redirect('/checkout?num=' + order.order_number)
    }).catch(err => next(err))
}
```

### 07.页面模板准备

```js
exports.checkout = (req, res, next) => {
    res.render('checkout.art')    //准备模板
}
```

### 08.核对订单信息渲染页面

```js
// 0.models/order.js准备数据
exports.item = (num) => {
  return axios.get(`orders/${num}`)
    .then(res => res.data)
    .catch(err => Promise.reject(err))
}
// 1.controller/orderd.js挂载数据
exports.checkout = (req, res, next) => {
  orderModel.item(req.query.num)
    .then(order => {
      res.locals.order = order
      res.render('checkout.art')
    }).catch(err => next(err))
}
// 2.渲染页面
// 收件人信息上面 再来一条 step-tit  主要是显示订单信息	
<div class="step-tit"> <h5> <span>当前收件人信息</span></h5></div>    
<div class="step-cont">{{order.express_address}}</div>
// 商品清单下面写
 {{each order.products}}	
<ul class="yui3-g">
<li class="yui3-u-1-6"><img src="{{$value.thumbnail}}"></li>      
<li class="yui3-u-2-3"><div class="desc">{{$value.name}}</div></li>
<li class="yui3-u-1-12"><div class="price">￥{{$value.price}}</div></li>
<li class="yui3-u-1-12"><div class="num">x<strong>{{$value.amount}}</strong></div>
{{/each}}
// 商品数量和总价
{{order.total_amount}}、{{order.total_price}}            
// 立即支付
href="/pay?num={{order.order_number}}
```

### 09.沙箱环境的信息了解

1. 公钥私钥放到util

### 10.封装一个获取支付地址的函数

·1.下载alipay-node-sdk

```js
//util/alipay.js
//获取支付地址 = 支付宝网关 + ‘？’ + 加密后的参数
const path = require('path')
/*1. 使用第三方的包  alipay-node-sdk */
const Alipay = require('alipay-node-sdk')
/*2. 得到构造函数 实例化后去对参数进行加密*/
const alipay = new Alipay({
  //应用ID
  appId: '2016092300579138',
  //通知地址
  notifyUrl: 'http://127.0.0.1:3000/pay/notify',
  //私钥
  rsaPrivate: path.join(__dirname, './rsa_private_key.pem'),
  //公钥
  rsaPublic: path.join(__dirname, './rsa_public_key.pem'),
  //是否是测试环境
  sandbox: true,
  //加密算法类型
  signType: 'RSA2'
})

exports.getPayUrl = (order) => {
  /*3. 通过以上实例  对参数进行加密*/
  /*4. 订单不一样 参数不一样*/
  const params = alipay.pagePay({
    //支付的标题
    subject: '品优购商品',
    //具体哪一些商品
    body: order.products.map((item, i) => item.name).join('\n'),
    //商户的交易编号
    outTradeId: order.order_number,
    //超时时间
    timeout: '10m',
    //支付金额
    amount: order.total_price,
    //商品类型   虚拟 0  实物  1
    goodsType: '1',
    //二维码支付模式  确定二维码的类型
    qrPayMode: 2,
    //回调的地址
    return_url:'http://127.0.0.1:3000/pay/callback'
  })
  return 'https://openapi.alipaydev.com/gateway.do?' + params
}
```

```js
router.get('/pay', middlewares.checkLogin, payController.pay)
```

```js
// constroller/pay.js
const orderModel = require('../models/order')
const alipay = require('../utils/alipay')
exports.pay = (req, res, next) => {
  //进行支付
  const num = req.query.num
  //获取订单信息  需要订单编号
  orderModel.item(num)
    .then(order => {
      //获取支付地址
      const url = alipay.getPayUrl(order)
      //跳转支付宝
      res.redirect(url)
    }).catch(err => next(err))
}
```

```js
// 成功回调页面
router.get('/pay/callback', payController.callback)
```

```js
// controller/pay.js
exports.callback = (req, res, next) => {
  //修改订单的状态
  //获取订单的编号  req.query.out_trade_no
  //支付宝流水  req.query.trade_no
  const out_trade_no = req.query.out_trade_no
  const trade_no = req.query.trade_no
  orderModel.edit(out_trade_no, 1, trade_no)
    .then(order => {
      //成功提示 订单信息  页面展示
      res.locals.order = order
      res.render('paySuccess.art')
    }).catch(err => next(err))
}
```

```js
// models/order.js
exports.edit = (num, pay_status, trade_no) => {
    return axios.patch(`orders/${num}`, {
            pay_status,
            trade_no
        })
        .then(res => res.data)
        .catch(err => Promise.reject(err))
}
```

```js
// 获取全部订单路由
router.get('/order', middlewares.checkLogin, orderController.list)  //全部订单
```

```js
// controller/order.js
exports.list = (req, res, next) => {
  //获取全部订单数据
  orderModel.list(req.session.user.id)
    .then(list => {
      res.locals.list = list
      res.render('order.art')
    }).catch(err => next(err))
}
```

```js
//models/order.js查询所有
exports.list = (userId) => {
  return axios.get(`orders/?user_id=${userId}`)
    .then(res => res.data)
    .catch(err => Promise.reject(err))
}
```

```js
// order.art
{{each list order i}}
 <div class="orders">
     <span class="ordertitle">
         {{order.create_time}}　
         订单编号：{{order.order_number}}
	</span>
	 {{each order.products}}
        <div class="goods-info">
            <img src="{{$value.thumbnail}}" height="100">
                <a href="#" class="block-text">{{$value.name}}</a>
        <span>x{{$value.amount}}</span>
        </div>
	{{/each}}
 	<td width="10%" class="center">{{order.express_address}}</td>
     <p>总金额¥{{order.total_price}}</p>
     <td width="10%" class="center">{{order.pay_status}}</td>
{{/each}}                                    
```

### 11.走通支付宝扫码页面

### 12.走通支付宝回调自己的成功页面

### 13.定义回调路由&修改订单状态

### 14.支付成功的提示页面渲染

### 15.订单列表模板准备

### 16.订单查看